/*
========================================================================================
    REPORTING MODULES
========================================================================================
*/

process MULTIQC {
    tag "multiqc"
    label 'process_low'
    publishDir "${params.outdir}/reports", mode: 'copy'
    
    container 'quay.io/biocontainers/multiqc:1.19--pyhdfd78af_0'
    
    input:
    path multiqc_files
    path multiqc_config
    
    output:
    path "multiqc_report.html", emit: report
    path "multiqc_data", emit: data
    path "versions.yml", emit: versions
    
    script:
    def config_arg = multiqc_config ? "--config ${multiqc_config}" : ""
    """
    echo "[INFO] =============================================="
    echo "[INFO] Generating MultiQC report"
    echo "[INFO] =============================================="
    
    multiqc \\
        --force \\
        ${config_arg} \\
        --title "ONT Germline WGS Analysis Report" \\
        --comment "Generated by wf-ont-germline pipeline" \\
        .
    
    echo "[INFO] MultiQC report generated"
    
    cat <<-END_VERSIONS > versions.yml
    "${task.process}":
        multiqc: \$(multiqc --version | sed 's/multiqc, version //')
    END_VERSIONS
    """
    
    stub:
    """
    mkdir -p multiqc_data
    touch multiqc_report.html
    
    cat <<-END_VERSIONS > versions.yml
    "${task.process}":
        multiqc: 1.19
    END_VERSIONS
    """
}

process GENERATE_REPORT {
    tag "$sample_id"
    label 'process_low'
    publishDir "${params.outdir}/reports", mode: 'copy'
    
    container 'quay.io/biocontainers/python:3.11'
    
    input:
    tuple val(sample_id), path(snv_vcf), path(snv_vcf_tbi)
    path sv_vcf
    path cnv_vcf
    path coverage_summary
    
    output:
    tuple val(sample_id), path("${sample_id}_final_report.html"), emit: html_report
    tuple val(sample_id), path("${sample_id}_summary.json"), emit: json_summary
    path "versions.yml", emit: versions
    
    script:
    """
    echo "[INFO] =============================================="
    echo "[INFO] Generating final analysis report"
    echo "[INFO] Sample: ${sample_id}"
    echo "[INFO] =============================================="
    
    python3 << 'PYTHON'
import json
import gzip
from datetime import datetime
from pathlib import Path

def count_vcf_variants(vcf_path):
    #Count variants in a VCF file
    if not Path(vcf_path).exists():
        return 0
    count = 0
    opener = gzip.open if str(vcf_path).endswith('.gz') else open
    try:
        with opener(vcf_path, 'rt') as f:
            for line in f:
                if not line.startswith('#'):
                    count += 1
    except:
        pass
    return count

def parse_coverage_summary(summary_path):
    #Parse mosdepth summary file
    coverage_data = {}
    try:
        with open(summary_path, 'r') as f:
            header = f.readline().strip().split('\\t')
            for line in f:
                fields = line.strip().split('\\t')
                if fields[0] == 'total':
                    coverage_data['mean_coverage'] = float(fields[3])
                    coverage_data['min_coverage'] = float(fields[4]) if len(fields) > 4 else 0
                    coverage_data['max_coverage'] = float(fields[5]) if len(fields) > 5 else 0
    except:
        coverage_data = {'mean_coverage': 'N/A', 'min_coverage': 'N/A', 'max_coverage': 'N/A'}
    return coverage_data

# Collect statistics
sample_id = "${sample_id}"
snv_count = count_vcf_variants("${snv_vcf}")
sv_count = count_vcf_variants("${sv_vcf}") if "${sv_vcf}" != "[]" else 0
cnv_count = count_vcf_variants("${cnv_vcf}") if "${cnv_vcf}" != "[]" else 0

coverage_files = "${coverage_summary}".split()
coverage_data = {}
for cf in coverage_files:
    if Path(cf).exists():
        coverage_data = parse_coverage_summary(cf)
        break

# Create summary JSON
summary = {
    "sample_id": sample_id,
    "analysis_date": datetime.now().isoformat(),
    "pipeline_version": "1.0.0",
    "variants": {
        "snv_indel_count": snv_count,
        "sv_count": sv_count,
        "cnv_count": cnv_count,
        "total_count": snv_count + sv_count + cnv_count
    },
    "coverage": coverage_data,
    "status": "completed"
}

with open(f"{sample_id}_summary.json", 'w') as f:
    json.dump(summary, f, indent=2)

# Generate HTML report
html_content = f'''<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONT Germline Analysis Report - {sample_id}</title>
    <style>
        :root {{
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
        }}
        
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: var(--light-bg);
        }}
        
        .container {{
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }}
        
        header {{
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 10px;
        }}
        
        header h1 {{
            font-size: 2.5em;
            margin-bottom: 10px;
        }}
        
        header .subtitle {{
            font-size: 1.2em;
            opacity: 0.9;
        }}
        
        .card {{
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }}
        
        .card-header {{
            background: var(--primary-color);
            color: white;
            padding: 15px 20px;
            font-size: 1.2em;
            font-weight: 600;
        }}
        
        .card-body {{
            padding: 20px;
        }}
        
        .stats-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }}
        
        .stat-box {{
            background: var(--light-bg);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--secondary-color);
        }}
        
        .stat-box.success {{
            border-left-color: var(--success-color);
        }}
        
        .stat-box.warning {{
            border-left-color: var(--warning-color);
        }}
        
        .stat-value {{
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
        }}
        
        .stat-label {{
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }}
        
        table {{
            width: 100%;
            border-collapse: collapse;
        }}
        
        th, td {{
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }}
        
        th {{
            background: var(--light-bg);
            font-weight: 600;
        }}
        
        tr:hover {{
            background: #f5f5f5;
        }}
        
        .badge {{
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }}
        
        .badge-success {{
            background: #d4edda;
            color: #155724;
        }}
        
        .badge-info {{
            background: #d1ecf1;
            color: #0c5460;
        }}
        
        footer {{
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }}
        
        .pipeline-info {{
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }}
        
        .pipeline-info span {{
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
        }}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ONT Germline Analysis Report</h1>
            <p class="subtitle">Sample: {sample_id}</p>
            <div class="pipeline-info">
                <span>Pipeline: wf-ont-germline v1.0.0</span>
                <span>Date: {datetime.now().strftime("%Y-%m-%d %H:%M")}</span>
                <span>Status: <span class="badge badge-success">Completed</span></span>
            </div>
        </header>
        
        <div class="card">
            <div class="card-header">Variant Summary</div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">{snv_count:,}</div>
                        <div class="stat-label">SNVs & Indels</div>
                    </div>
                    <div class="stat-box success">
                        <div class="stat-value">{sv_count:,}</div>
                        <div class="stat-label">Structural Variants</div>
                    </div>
                    <div class="stat-box warning">
                        <div class="stat-value">{cnv_count:,}</div>
                        <div class="stat-label">Copy Number Variants</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{snv_count + sv_count + cnv_count:,}</div>
                        <div class="stat-label">Total Variants</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">Coverage Statistics</div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">{coverage_data.get('mean_coverage', 'N/A')}</div>
                        <div class="stat-label">Mean Coverage (X)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">Analysis Pipeline</div>
            <div class="card-body">
                <table>
                    <tr>
                        <th>Step</th>
                        <th>Tool</th>
                        <th>Status</th>
                    </tr>
                    <tr>
                        <td>Quality Control</td>
                        <td>NanoPlot, mosdepth</td>
                        <td><span class="badge badge-success">Completed</span></td>
                    </tr>
                    <tr>
                        <td>Alignment</td>
                        <td>minimap2</td>
                        <td><span class="badge badge-success">Completed</span></td>
                    </tr>
                    <tr>
                        <td>SNV/Indel Calling</td>
                        <td>Clair3 / PEPPER-DeepVariant</td>
                        <td><span class="badge badge-success">Completed</span></td>
                    </tr>
                    <tr>
                        <td>SV Calling</td>
                        <td>Sniffles2</td>
                        <td><span class="badge badge-success">Completed</span></td>
                    </tr>
                    <tr>
                        <td>CNV Calling</td>
                        <td>Spectre</td>
                        <td><span class="badge badge-success">Completed</span></td>
                    </tr>
                    <tr>
                        <td>Phasing</td>
                        <td>WhatsHap</td>
                        <td><span class="badge badge-success">Completed</span></td>
                    </tr>
                    <tr>
                        <td>Methylation</td>
                        <td>modkit</td>
                        <td><span class="badge badge-success">Completed</span></td>
                    </tr>
                    <tr>
                        <td>Annotation</td>
                        <td>VEP, ClinVar, gnomAD, CADD, etc.</td>
                        <td><span class="badge badge-success">Completed</span></td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">Annotation Databases</div>
            <div class="card-body">
                <table>
                    <tr>
                        <th>Database</th>
                        <th>Description</th>
                        <th>Type</th>
                    </tr>
                    <tr>
                        <td>ClinVar</td>
                        <td>Clinical significance of variants</td>
                        <td><span class="badge badge-info">Clinical</span></td>
                    </tr>
                    <tr>
                        <td>gnomAD</td>
                        <td>Population allele frequencies</td>
                        <td><span class="badge badge-info">Population</span></td>
                    </tr>
                    <tr>
                        <td>dbSNP</td>
                        <td>Variant identifiers (rsIDs)</td>
                        <td><span class="badge badge-info">Reference</span></td>
                    </tr>
                    <tr>
                        <td>CADD</td>
                        <td>Deleteriousness scores</td>
                        <td><span class="badge badge-info">Pathogenicity</span></td>
                    </tr>
                    <tr>
                        <td>REVEL</td>
                        <td>Missense pathogenicity</td>
                        <td><span class="badge badge-info">Pathogenicity</span></td>
                    </tr>
                    <tr>
                        <td>SpliceAI</td>
                        <td>Splice site predictions</td>
                        <td><span class="badge badge-info">Functional</span></td>
                    </tr>
                    <tr>
                        <td>PharmGKB</td>
                        <td>Pharmacogenomics</td>
                        <td><span class="badge badge-info">Clinical</span></td>
                    </tr>
                    <tr>
                        <td>COSMIC</td>
                        <td>Cancer mutations</td>
                        <td><span class="badge badge-info">Cancer</span></td>
                    </tr>
                    <tr>
                        <td>OMIM</td>
                        <td>Disease associations</td>
                        <td><span class="badge badge-info">Disease</span></td>
                    </tr>
                </table>
            </div>
        </div>
        
        <footer>
            <p>Generated by wf-ont-germline pipeline | Oxford Nanopore Technologies</p>
            <p>Report generated on {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}</p>
        </footer>
    </div>
</body>
</html>
'''

with open(f"{sample_id}_final_report.html", 'w') as f:
    f.write(html_content)

print(f"[INFO] Report generated: {sample_id}_final_report.html")
print(f"[INFO] Summary JSON: {sample_id}_summary.json")
PYTHON
    
    cat <<-END_VERSIONS > versions.yml
    "${task.process}":
        python: \$(python3 --version | sed 's/Python //')
    END_VERSIONS
    """
    
    stub:
    """
    touch ${sample_id}_final_report.html
    touch ${sample_id}_summary.json
    
    cat <<-END_VERSIONS > versions.yml
    "${task.process}":
        python: 3.11
    END_VERSIONS
    """
}

process COLLECT_VERSIONS {
    tag "versions"
    label 'process_low'
    publishDir "${params.outdir}/pipeline_info", mode: 'copy'
    
    input:
    path versions
    
    output:
    path "software_versions.yml", emit: versions
    path "software_versions.html", emit: html
    
    script:
    """
    echo "[INFO] Collecting software versions"
    
    # Merge all version files
    cat ${versions} > software_versions.yml
    
    # Generate HTML version table
    python3 << 'PYTHON'
import yaml
from pathlib import Path

# Read all version info
versions = {}
for vfile in Path('.').glob('*.yml'):
    try:
        with open(vfile) as f:
            data = yaml.safe_load(f)
            if data:
                versions.update(data)
    except:
        pass

# Generate HTML
html = '''<!DOCTYPE html>
<html>
<head>
    <title>Software Versions</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #2c3e50; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Software Versions</h1>
    <table>
        <tr><th>Process</th><th>Software</th><th>Version</th></tr>
'''

for process, tools in sorted(versions.items()):
    if isinstance(tools, dict):
        for tool, version in tools.items():
            html += f'        <tr><td>{process}</td><td>{tool}</td><td>{version}</td></tr>\\n'

html += '''    </table>
</body>
</html>'''

with open('software_versions.html', 'w') as f:
    f.write(html)
PYTHON
    """
    
    stub:
    """
    touch software_versions.yml
    touch software_versions.html
    """
}
