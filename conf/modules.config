/*
========================================================================================
    Modules Configuration
========================================================================================
    Config file for defining DSL2 per module options and publishing paths
----------------------------------------------------------------------------------------
*/

process {
    
    // =====================
    // PUBLISH DIRECTORIES
    // =====================
    
    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]
    
    // =====================
    // QC MODULES
    // =====================
    
    withName: 'NANOPLOT' {
        publishDir = [
            path: { "${params.outdir}/qc/nanoplot" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'MOSDEPTH' {
        publishDir = [
            path: { "${params.outdir}/qc/coverage" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'FASTQC_LONG' {
        publishDir = [
            path: { "${params.outdir}/qc/fastqc" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'PYCOQC' {
        publishDir = [
            path: { "${params.outdir}/qc/pycoqc" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'CRAMINO' {
        publishDir = [
            path: { "${params.outdir}/qc/cramino" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    // =====================
    // ALIGNMENT MODULES
    // =====================
    
    withName: 'MINIMAP2_ALIGN' {
        publishDir = [
            path: { "${params.outdir}/alignment" },
            mode: 'copy',
            pattern: '*.bam*',
            enabled: false  // Don't publish unsorted BAM
        ]
    }
    
    withName: 'SAMTOOLS_SORT_INDEX' {
        publishDir = [
            [
                path: { "${params.outdir}/alignment" },
                mode: 'copy',
                pattern: '*.sorted.bam*'
            ],
            [
                path: { "${params.outdir}/qc/alignment_stats" },
                mode: 'copy',
                pattern: '*.{flagstat,idxstats}.txt'
            ]
        ]
    }
    
    withName: 'SAMTOOLS_MERGE' {
        publishDir = [
            path: { "${params.outdir}/alignment" },
            mode: 'copy',
            pattern: '*.merged.bam*'
        ]
    }
    
    withName: 'SAMTOOLS_STATS' {
        publishDir = [
            path: { "${params.outdir}/qc/alignment_stats" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    // =====================
    // VARIANT CALLING MODULES
    // =====================
    
    withName: 'CLAIR3' {
        publishDir = [
            [
                path: { "${params.outdir}/variants/small_variants" },
                mode: 'copy',
                pattern: '*.vcf.gz*'
            ],
            [
                path: { "${params.outdir}/variants/small_variants/clair3_output" },
                mode: 'copy',
                pattern: '*_clair3/'
            ]
        ]
    }
    
    withName: 'PEPPER_DEEPVARIANT' {
        publishDir = [
            path: { "${params.outdir}/variants/small_variants" },
            mode: 'copy',
            pattern: '*.vcf.gz*'
        ]
    }
    
    withName: 'SNIFFLES2' {
        publishDir = [
            [
                path: { "${params.outdir}/variants/structural" },
                mode: 'copy',
                pattern: '*.vcf.gz*'
            ],
            [
                path: { "${params.outdir}/variants/structural" },
                mode: 'copy',
                pattern: '*.snf'
            ]
        ]
    }
    
    withName: 'CUTESV' {
        publishDir = [
            path: { "${params.outdir}/variants/structural" },
            mode: 'copy',
            pattern: '*.vcf.gz*'
        ]
    }
    
    withName: 'MERGE_SV_CALLS' {
        publishDir = [
            path: { "${params.outdir}/variants/structural" },
            mode: 'copy',
            pattern: '*merged*.vcf.gz*'
        ]
    }
    
    // =====================
    // CNV MODULES
    // =====================
    
    withName: 'SPECTRE' {
        publishDir = [
            [
                path: { "${params.outdir}/variants/cnv" },
                mode: 'copy',
                pattern: '*.vcf.gz*'
            ],
            [
                path: { "${params.outdir}/variants/cnv/spectre_output" },
                mode: 'copy',
                pattern: '*_spectre/'
            ]
        ]
    }
    
    withName: 'QDNASEQ' {
        publishDir = [
            path: { "${params.outdir}/variants/cnv" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'CNVPYTOR' {
        publishDir = [
            path: { "${params.outdir}/variants/cnv" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'MOSDEPTH_CNV' {
        publishDir = [
            path: { "${params.outdir}/variants/cnv/coverage" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'MERGE_CNV_CALLS' {
        publishDir = [
            path: { "${params.outdir}/variants/cnv" },
            mode: 'copy',
            pattern: '*merged*.vcf.gz*'
        ]
    }
    
    // =====================
    // PHASING MODULES
    // =====================
    
    withName: 'WHATSHAP_PHASE' {
        publishDir = [
            [
                path: { "${params.outdir}/phasing" },
                mode: 'copy',
                pattern: '*.phased.vcf.gz*'
            ],
            [
                path: { "${params.outdir}/phasing/logs" },
                mode: 'copy',
                pattern: '*.log'
            ]
        ]
    }
    
    withName: 'WHATSHAP_HAPLOTAG' {
        publishDir = [
            [
                path: { "${params.outdir}/phasing" },
                mode: 'copy',
                pattern: '*.haplotagged.bam*'
            ],
            [
                path: { "${params.outdir}/phasing/logs" },
                mode: 'copy',
                pattern: '*.log'
            ],
            [
                path: { "${params.outdir}/phasing" },
                mode: 'copy',
                pattern: '*.haplotag_list.tsv.gz'
            ]
        ]
    }
    
    withName: 'WHATSHAP_STATS' {
        publishDir = [
            path: { "${params.outdir}/phasing/stats" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'WHATSHAP_COMPARE' {
        publishDir = [
            path: { "${params.outdir}/phasing/comparison" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'LONGPHASE' {
        publishDir = [
            path: { "${params.outdir}/phasing" },
            mode: 'copy',
            pattern: '*.vcf.gz*'
        ]
    }
    
    // =====================
    // METHYLATION MODULES
    // =====================
    
    withName: 'MODKIT_PILEUP' {
        publishDir = [
            path: { "${params.outdir}/methylation" },
            mode: 'copy',
            pattern: '*.bedmethyl.gz*'
        ]
    }
    
    withName: 'MODKIT_SUMMARY' {
        publishDir = [
            path: { "${params.outdir}/methylation/summary" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'MODKIT_EXTRACT' {
        publishDir = [
            path: { "${params.outdir}/methylation/extract" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'MODKIT_DMR' {
        publishDir = [
            path: { "${params.outdir}/methylation/dmr" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'METHYLATION_QC' {
        publishDir = [
            path: { "${params.outdir}/methylation/qc" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'BEDMETHYL_TO_BIGWIG' {
        publishDir = [
            path: { "${params.outdir}/methylation/bigwig" },
            mode: 'copy',
            pattern: '*.bw'
        ]
    }
    
    // =====================
    // ANNOTATION MODULES
    // =====================
    
    withName: 'VEP_ANNOTATE' {
        publishDir = [
            [
                path: { "${params.outdir}/annotation/vep" },
                mode: 'copy',
                pattern: '*.vcf.gz*'
            ],
            [
                path: { "${params.outdir}/annotation/vep" },
                mode: 'copy',
                pattern: '*_summary.html'
            ]
        ]
    }
    
    withName: 'CLINVAR_ANNOTATE' {
        publishDir = [
            path: { "${params.outdir}/annotation/intermediate" },
            mode: 'copy',
            pattern: '*.vcf.gz*',
            enabled: false  // Don't publish intermediate files
        ]
    }
    
    withName: 'GNOMAD_ANNOTATE' {
        publishDir = [
            path: { "${params.outdir}/annotation/intermediate" },
            mode: 'copy',
            pattern: '*.vcf.gz*',
            enabled: false
        ]
    }
    
    withName: 'DBSNP_ANNOTATE' {
        publishDir = [
            path: { "${params.outdir}/annotation/intermediate" },
            mode: 'copy',
            pattern: '*.vcf.gz*',
            enabled: false
        ]
    }
    
    withName: 'CADD_ANNOTATE' {
        publishDir = [
            path: { "${params.outdir}/annotation/intermediate" },
            mode: 'copy',
            pattern: '*.vcf.gz*',
            enabled: false
        ]
    }
    
    withName: 'REVEL_ANNOTATE' {
        publishDir = [
            path: { "${params.outdir}/annotation/intermediate" },
            mode: 'copy',
            pattern: '*.vcf.gz*',
            enabled: false
        ]
    }
    
    withName: 'SPLICEAI_ANNOTATE' {
        publishDir = [
            path: { "${params.outdir}/annotation/intermediate" },
            mode: 'copy',
            pattern: '*.vcf.gz*',
            enabled: false
        ]
    }
    
    withName: 'PHARMGKB_ANNOTATE' {
        publishDir = [
            [
                path: { "${params.outdir}/annotation/intermediate" },
                mode: 'copy',
                pattern: '*.vcf.gz*',
                enabled: false
            ],
            [
                path: { "${params.outdir}/annotation/pharmacogenomics" },
                mode: 'copy',
                pattern: '*pgx_variants.tsv'
            ]
        ]
    }
    
    withName: 'COSMIC_ANNOTATE' {
        publishDir = [
            path: { "${params.outdir}/annotation/intermediate" },
            mode: 'copy',
            pattern: '*.vcf.gz*',
            enabled: false
        ]
    }
    
    withName: 'OMIM_ANNOTATE' {
        publishDir = [
            path: { "${params.outdir}/annotation/intermediate" },
            mode: 'copy',
            pattern: '*.vcf.gz*',
            enabled: false
        ]
    }
    
    withName: 'MERGE_ANNOTATIONS' {
        publishDir = [
            [
                path: { "${params.outdir}/annotation/final" },
                mode: 'copy',
                pattern: '*.fully_annotated.vcf.gz*'
            ],
            [
                path: { "${params.outdir}/annotation/final" },
                mode: 'copy',
                pattern: '*_summary.txt'
            ]
        ]
    }
    
    withName: 'FILTER_CLINICAL_VARIANTS' {
        publishDir = [
            [
                path: { "${params.outdir}/annotation/clinical" },
                mode: 'copy',
                pattern: '*.pathogenic.vcf.gz*'
            ],
            [
                path: { "${params.outdir}/annotation/clinical" },
                mode: 'copy',
                pattern: '*.rare_damaging.vcf.gz*'
            ],
            [
                path: { "${params.outdir}/annotation/clinical" },
                mode: 'copy',
                pattern: '*_clinical_report.tsv'
            ]
        ]
    }
    
    // =====================
    // REPORTING MODULES
    // =====================
    
    withName: 'MULTIQC' {
        publishDir = [
            path: { "${params.outdir}/reports" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'GENERATE_REPORT' {
        publishDir = [
            path: { "${params.outdir}/reports" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: 'COLLECT_VERSIONS' {
        publishDir = [
            path: { "${params.outdir}/pipeline_info" },
            mode: 'copy',
            pattern: '*'
        ]
    }
}
