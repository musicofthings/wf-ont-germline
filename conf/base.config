/*
========================================================================================
    Base Configuration
========================================================================================
    Default resource requirements for all processes
----------------------------------------------------------------------------------------
*/

process {
    
    // Default resources
    cpus   = { check_max( 2    * task.attempt, 'cpus'   ) }
    memory = { check_max( 4.GB * task.attempt, 'memory' ) }
    time   = { check_max( 4.h  * task.attempt, 'time'   ) }
    
    // Error handling strategy
    errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'finish' }
    maxRetries    = 2
    maxErrors     = '-1'
    
    // Process-specific resource requirements
    
    // =====================
    // LOW RESOURCE PROCESSES
    // =====================
    withLabel: 'process_low' {
        cpus   = { check_max( 2     * task.attempt, 'cpus'   ) }
        memory = { check_max( 4.GB  * task.attempt, 'memory' ) }
        time   = { check_max( 2.h   * task.attempt, 'time'   ) }
    }
    
    // =====================
    // MEDIUM RESOURCE PROCESSES
    // =====================
    withLabel: 'process_medium' {
        cpus   = { check_max( 8     * task.attempt, 'cpus'   ) }
        memory = { check_max( 16.GB * task.attempt, 'memory' ) }
        time   = { check_max( 8.h   * task.attempt, 'time'   ) }
    }
    
    // =====================
    // HIGH RESOURCE PROCESSES
    // =====================
    withLabel: 'process_high' {
        cpus   = { check_max( 16    * task.attempt, 'cpus'   ) }
        memory = { check_max( 64.GB * task.attempt, 'memory' ) }
        time   = { check_max( 24.h  * task.attempt, 'time'   ) }
    }
    
    // =====================
    // VERY HIGH RESOURCE PROCESSES
    // =====================
    withLabel: 'process_very_high' {
        cpus   = { check_max( 32     * task.attempt, 'cpus'   ) }
        memory = { check_max( 128.GB * task.attempt, 'memory' ) }
        time   = { check_max( 48.h   * task.attempt, 'time'   ) }
    }
    
    // =====================
    // LONG RUNNING PROCESSES
    // =====================
    withLabel: 'process_long' {
        time   = { check_max( 72.h  * task.attempt, 'time'   ) }
    }
    
    // =====================
    // HIGH MEMORY PROCESSES
    // =====================
    withLabel: 'process_high_memory' {
        memory = { check_max( 128.GB * task.attempt, 'memory' ) }
    }
    
    // =====================
    // PROCESS-SPECIFIC OVERRIDES
    // =====================
    
    // QC processes
    withName: 'NANOPLOT' {
        cpus   = { check_max( 4     * task.attempt, 'cpus'   ) }
        memory = { check_max( 8.GB  * task.attempt, 'memory' ) }
        time   = { check_max( 4.h   * task.attempt, 'time'   ) }
    }
    
    withName: 'MOSDEPTH' {
        cpus   = { check_max( 4     * task.attempt, 'cpus'   ) }
        memory = { check_max( 8.GB  * task.attempt, 'memory' ) }
        time   = { check_max( 2.h   * task.attempt, 'time'   ) }
    }
    
    // Alignment processes
    withName: 'MINIMAP2_ALIGN' {
        cpus   = { check_max( 16    * task.attempt, 'cpus'   ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 12.h  * task.attempt, 'time'   ) }
    }
    
    withName: 'SAMTOOLS_SORT_INDEX' {
        cpus   = { check_max( 8     * task.attempt, 'cpus'   ) }
        memory = { check_max( 16.GB * task.attempt, 'memory' ) }
        time   = { check_max( 6.h   * task.attempt, 'time'   ) }
    }
    
    // Variant calling processes
    withName: 'CLAIR3' {
        cpus   = { check_max( 16    * task.attempt, 'cpus'   ) }
        memory = { check_max( 64.GB * task.attempt, 'memory' ) }
        time   = { check_max( 24.h  * task.attempt, 'time'   ) }
    }
    
    withName: 'PEPPER_DEEPVARIANT' {
        cpus   = { check_max( 16    * task.attempt, 'cpus'   ) }
        memory = { check_max( 64.GB * task.attempt, 'memory' ) }
        time   = { check_max( 36.h  * task.attempt, 'time'   ) }
    }
    
    withName: 'SNIFFLES2' {
        cpus   = { check_max( 8     * task.attempt, 'cpus'   ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 8.h   * task.attempt, 'time'   ) }
    }
    
    withName: 'CUTESV' {
        cpus   = { check_max( 8     * task.attempt, 'cpus'   ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 8.h   * task.attempt, 'time'   ) }
    }
    
    // CNV calling processes
    withName: 'SPECTRE' {
        cpus   = { check_max( 8     * task.attempt, 'cpus'   ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 12.h  * task.attempt, 'time'   ) }
    }
    
    withName: 'CNVPYTOR' {
        cpus   = { check_max( 8     * task.attempt, 'cpus'   ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 8.h   * task.attempt, 'time'   ) }
    }
    
    // Phasing processes
    withName: 'WHATSHAP_PHASE' {
        cpus   = { check_max( 4     * task.attempt, 'cpus'   ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 12.h  * task.attempt, 'time'   ) }
    }
    
    withName: 'WHATSHAP_HAPLOTAG' {
        cpus   = { check_max( 8     * task.attempt, 'cpus'   ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 12.h  * task.attempt, 'time'   ) }
    }
    
    withName: 'LONGPHASE' {
        cpus   = { check_max( 16    * task.attempt, 'cpus'   ) }
        memory = { check_max( 64.GB * task.attempt, 'memory' ) }
        time   = { check_max( 24.h  * task.attempt, 'time'   ) }
    }
    
    // Methylation processes
    withName: 'MODKIT_PILEUP' {
        cpus   = { check_max( 16    * task.attempt, 'cpus'   ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 24.h  * task.attempt, 'time'   ) }
    }
    
    withName: 'MODKIT_SUMMARY' {
        cpus   = { check_max( 4     * task.attempt, 'cpus'   ) }
        memory = { check_max( 8.GB  * task.attempt, 'memory' ) }
        time   = { check_max( 2.h   * task.attempt, 'time'   ) }
    }
    
    // Annotation processes
    withName: 'VEP_ANNOTATE' {
        cpus   = { check_max( 8     * task.attempt, 'cpus'   ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 12.h  * task.attempt, 'time'   ) }
    }
    
    withName: 'CLINVAR_ANNOTATE|GNOMAD_ANNOTATE|DBSNP_ANNOTATE|COSMIC_ANNOTATE|PHARMGKB_ANNOTATE|OMIM_ANNOTATE' {
        cpus   = { check_max( 4     * task.attempt, 'cpus'   ) }
        memory = { check_max( 16.GB * task.attempt, 'memory' ) }
        time   = { check_max( 4.h   * task.attempt, 'time'   ) }
    }
    
    withName: 'CADD_ANNOTATE|REVEL_ANNOTATE|SPLICEAI_ANNOTATE' {
        cpus   = { check_max( 8     * task.attempt, 'cpus'   ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 8.h   * task.attempt, 'time'   ) }
    }
    
    // Reporting processes
    withName: 'MULTIQC' {
        cpus   = { check_max( 2     * task.attempt, 'cpus'   ) }
        memory = { check_max( 4.GB  * task.attempt, 'memory' ) }
        time   = { check_max( 1.h   * task.attempt, 'time'   ) }
    }
    
    withName: 'GENERATE_REPORT' {
        cpus   = { check_max( 2     * task.attempt, 'cpus'   ) }
        memory = { check_max( 4.GB  * task.attempt, 'memory' ) }
        time   = { check_max( 1.h   * task.attempt, 'time'   ) }
    }
}
